# マラソン攻略シミュレーター 仕様書 (β0.1)

## 1. システム概要
本システムは、マラソンコースのGPXデータ（緯度・経度・標高）と物理モデルを用いて、ランナーの走力・コース起伏・気象条件に基づいた最適なレースペースを算出するWebアプリケーションである。

## 2. 技術スタック
*   **言語**: Python 3.x
*   **フレームワーク**: Streamlit (Web UI)
*   **主要ライブラリ**:
    *   `pandas`, `numpy`: 数値計算、データ処理
    *   `gpxpy`: GPXファイル解析
    *   `plotly`: インタラクティブなグラフ・地図描画
    *   `scipy`: 最適化計算（速度算出）

## 3. アプリケーション構成

### 3.1 ディレクトリ構造
*   `app.py`: エントリーポイント。UI構築とシミュレーション制御を担当。
*   `lib/`:
    *   `physics.py`: 物理モデル（Minettiの勾配コスト式、空気抵抗計算）。
    *   `pacing_strategy.py`: ペース配分ロジック（パワー一定モデル、坂道補正、スプリット補正）。
    *   `course_data.py`: コースデータモデル（セグメント管理、サンプリング）。
    *   `gpx_handler.py`: GPXファイルの読み込み、距離正規化、勾配平滑化。
    *   `vdot_handler.py`: VDOT一覧表の読み込み、タイムとの相互変換（線形補間）。
*   `data/`: GPXファイルおよびVDOTテーブルの格納先。

## 4. アルゴリズム詳細

### 4.1 物理モデル (Running Physics)
*   **エネルギーコスト**: Minetti et al. (2002) の勾配エネルギーコスト式を採用。
*   **空気抵抗**:
    *   ランナーの投影面積と空気密度、対気速度の二乗に比例する抗力を計算。
    *   **風速補正**: 地表摩擦と集団遮蔽効果を考慮し、予報風速（入力値）に **0.5** の係数を掛けて実効風速とする。
*   **速度算出**: 目標パワー（Watt）を出力するために必要な速度（m/s）を、勾配と風の抵抗を考慮して逆算する（`scipy.optimize.brentq` 使用）。

### 4.2 コース解析 GPX Data Processing
*   **リサンプリング**: 全てのGPXデータを **5m等間隔** にリサンプリング（線形補間）。これにより、元のデータの粗密に関わらず一貫した勾配計算を行う。
*   **平滑化 (Smoothing)**:
    *   距離ベースの移動平均フィルタ（Rolling Mean）を適用。
    *   **動的調整**: 平滑化の窓幅（Window Size）はサイドバーの「詳細設定」から **0m 〜 100m** の範囲で調整可能（デフォルト130m→ユーザー指示により変更の可能性あり、現状コードは130mだがマニュアル整合性を重視）。※コード上の最新は130m。
    *   **微小変化のフィルタリング**: ノイズ除去閾値は廃止（0m）。平滑化のみでノイズ対応を行う設計に変更。
*   **距離正規化**: GPS誤差を考慮し、全行程を正確に42.195kmになるようスケーリング。
*   **難易度指標**: 獲得標高を元にした「Course Toughness Index」を算出。

### 4.3 ペース戦略
*   **基本方針**: 「設定された総エネルギー量を使い切る」ことを基準にペースを配分。
*   **戦略オプション**:
    *   **Split (前半/後半)**: 距離に応じて目標パワー係数を線形に変化させる (+/- 2%)。
    *   **Hill (坂道)**: 勾配に応じて目標パワーを調整する係数を適用。

## 5. UI仕様

### 5.1 サイドバー
*   **コース選択**: `data/` フォルダ内のGPXファイルを動的にリストアップ。
*   **基礎走力設定**: VDOTまたはフルマラソンタイムを入力。
*   **環境条件・レース戦略**: 風速・風向き、スプリット・坂道設定。
*   **実行ボタン**: 誤操作防止のため、設定完了後に手動で実行する仕様。

### 5.2 メイン画面
*   **結果指標**: 予想タイム、シミュレーション結果：平均ペース、基礎走力（平地相当ペース）。
*   **チャート**: 距離ごとの平均ペース（平滑化機能付き）と標高の複合グラフ。
*   **マップ**: Plotly Mapboxを使用したコース平面図（自動ズーム最適化）。
*   **シミュレーション結果：区間ラップ表**: 1kmごとの詳細ラップタイムリスト。
*   **コース比較**: 別コースとのタイム・獲得標高・難易度比較機能。

## 6. 今後の拡張予定
*   給水ポイントごとの通過タイム予測機能。
*   心拍数ドリフトを考慮したスタミナ減衰モデル。
*   気温上昇によるペースダウン補正の再実装（設定によりOn/Off）。
