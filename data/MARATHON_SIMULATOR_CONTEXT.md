# マラソン攻略シミュレーター (MS) - Claude Code Desktop コンテキスト

## 1. プロジェクト概要

| 項目 | 内容 |
|:-----|:-----|
| アプリ名 | マラソン攻略シミュレーター |
| バージョン | β0.1 |
| 公開URL | https://akirun-marathon-simulator.streamlit.app/ |
| ブログLP | https://akirun.net/lp/marathon-simulator/ |
| 目的 | GPXデータと物理モデルによる最適レースペース算出 |
| 技術スタック | Python, Streamlit, pandas, numpy, gpxpy, plotly, scipy |

### 開発者情報
- **開発者**: あきら（AkiRun管理人）
- **実績**: フルマラソンPB 2:46:27（56歳）
- **ブログ**: https://akirun.net/（「走りを科学でアップデート」）

### ポジショニング
Minetti et al. (2002)の学術論文に基づく**物理計算**でペースを予測する、日本唯一のマラソンシミュレーター。「経験則」ではなく「エネルギー保存則」に基づく点が最大の差別化要素。

---

## 2. 技術仕様

### ディレクトリ構造
```
marathon-simulator/
├── app.py                    # エントリーポイント（UI構築・シミュレーション制御）
├── lib/
│   ├── physics.py            # 物理モデル（Minettiの勾配コスト式、空気抵抗計算）
│   ├── pacing_strategy.py    # ペース配分ロジック（パワー一定モデル、坂道補正、スプリット補正）
│   ├── course_data.py        # コースデータモデル（セグメント管理、サンプリング）
│   ├── gpx_handler.py        # GPXファイルの読み込み、距離正規化、勾配平滑化
│   └── vdot_handler.py       # VDOT一覧表の読み込み、タイムとの相互変換（線形補間）
└── data/                     # GPXファイルおよびVDOTテーブルの格納先
```

### 物理モデル (lib/physics.py)

#### エネルギーコスト
**Minetti et al. (2002)** の勾配エネルギーコスト式を採用。

#### 空気抵抗計算
- ランナーの投影面積と空気密度、対気速度の二乗に比例する抗力を計算
- **風速補正**: 地表摩擦と集団遮蔽効果を考慮し、予報風速に **0.5** の係数を掛けて実効風速とする

#### 速度算出
- 目標パワー（Watt）を出力するために必要な速度（m/s）を逆算
- `scipy.optimize.brentq` 使用

### GPXデータ処理 (lib/gpx_handler.py)

| 処理 | 内容 |
|:-----|:-----|
| リサンプリング | 全GPXデータを **5m等間隔** に線形補間 |
| 平滑化 | 距離ベースの移動平均フィルタ（窓幅: 0m〜100m、デフォルト130m） |
| 距離正規化 | GPS誤差を考慮し、全行程を正確に42.195kmにスケーリング |
| 難易度指標 | 獲得標高を元にした「Course Toughness Index」を算出 |

### ペース戦略 (lib/pacing_strategy.py)

**基本方針**: 「設定された総エネルギー量を使い切る」ことを基準にペースを配分

| 戦略オプション | 内容 |
|:---------------|:-----|
| Split（前半/後半） | 距離に応じて目標パワー係数を線形に変化（+/- 2%） |
| Hill（坂道） | 勾配に応じて目標パワーを調整する係数を適用 |

### 収録コース

#### 世界7大マラソン
東京 / ボストン / ロンドン / ベルリン / シカゴ / ニューヨークシティ / シドニー

#### 日本国内主要大会
大阪 / 別府大分 / 防府 / あおもり桜 / 新潟シティ / 金沢 / 富山 / 勝田 / 大田原 / つくば / 岡山 / 福岡 / 愛媛 など

---

## 3. UI改善タスク

### 優先度★★★（すぐやるべき）

#### 3.1 予想タイムを大きく・目立たせる【重要】
**現状**: 「3:31:10」という予想タイムは表示されているが、もっと強調すべき
**問題**: このアプリの**最大の価値**が視覚的に伝わりにくい
**改善案**: 
```python
# st.metric のカスタムCSSで数字を2倍サイズ、色を付ける
st.markdown("""
<style>
[data-testid="stMetricValue"] {
    font-size: 3rem;
    color: #FF6B6B;
}
</style>
""", unsafe_allow_html=True)
```

#### 3.2 開発者プロフィールを追加【重要】
**現状**: 「誰が作ったか」がアプリ内に表示されていない
**問題**: 信頼性・ブログへの導線が弱い
**改善案**: サイドバーまたはフッターに以下を追加
```
開発者: あきら（PB 2:46:27 / 56歳）
ブログ: AkiRun | 走りを科学でアップデート
```

#### 3.3 AkiRunブログへの導線強化
**現状**: フッターに控えめな表示のみ
**改善案**: ヘッダーまたはサイドバーにロゴ付きリンクバナーを設置

#### 3.4 コース比較結果の「タイム差」を強調【実際の操作で確認】
**現状**: コース比較機能があり、タイム差（例: -0分13秒）は緑色バッジで表示されている
**問題**: バッジは小さく、「どちらが速いか」の結論が一目でわかりにくい
**改善案**: 
- タイム差を大きく表示（例: 「ボストンなら **13秒速い！**」）
- 比較結果に一言コメント追加（例: 「PR狙いならボストンがおすすめ」）
- 差がプラス/マイナスで背景色も変える（緑=速い、赤=遅い）
```python
if time_diff < 0:
    st.success(f"🏆 {compare_course}なら **{abs(time_diff)}秒速い！** PR狙いにおすすめ")
else:
    st.warning(f"⚠️ {compare_course}は **{time_diff}秒遅い** 記録狙いには不向き")
```

### 優先度★★☆（1ヶ月以内）

#### 3.5 コース選択時にサムネイル表示
**現状**: ドロップダウンでコース名だけが並んでいる
**改善案**: コース選択時に小さなコースマップをプレビュー表示

#### 3.6 「結果をシェア」ボタン
**現状**: 結果を共有する手段がない
**改善案**: X（Twitter）にワンクリックでシェアできるボタンを追加
```
【マラソン攻略シミュレーター】
ベルリンマラソン: 予想タイム 3:31:10
VDOT: 44.60
#マラソン #ベルリンマラソン
https://akirun-marathon-simulator.streamlit.app/
```

#### 3.7 「基礎走力（平地相当ペース）」の説明追加
**現状**: 「4:58/km このペース感覚を維持してください」と表示
**問題**: 初心者にはこの意味がわかりにくい可能性
**改善案**: ツールチップまたはExpanderで「なぜ平地換算ペースが重要か」を説明

### 優先度★☆☆（将来）

#### 3.8 給水ポイント通過時刻機能【仕様書に記載あり】
**概要**: 5km毎の給水ポイント通過予想時刻を表示
**実用性**: 非常に高い（レース当日に使える）
**ブログ記事化**: 「東京マラソン給水ポイント完全ガイド」等の記事ネタになる

#### 3.9 気温補正の再実装【仕様書に記載あり】
**概要**: 気温上昇によるペースダウン補正
**需要**: 夏〜秋のレースシーズンに高い

#### 3.10 コース詳細レポートPDF出力
**概要**: 1km区間ごとの詳細分析をPDFで出力
**収益化オプション**: 300円/回の有料機能として検討

---

## 4. 収益化との連携

### ブログ記事との連動

#### 既存記事
- 「マラソンのゴールタイムを物理計算で予測！」（https://akirun.net/marathon-simulator-guide/）

#### 量産すべき記事タイプ
| 記事タイプ | 例 | 狙うキーワード |
|:-----------|:---|:---------------|
| コース攻略 | 「つくばマラソン完全攻略：物理計算で導く最適ペース」 | 「〇〇マラソン 攻略」 |
| コース比較 | 「東京 vs 大阪マラソン：どちらがPB狙える？」 | 「〇〇マラソン vs △△マラソン」 |
| タイム別 | 「サブ3達成に最適なコースランキング」 | 「サブ3 コース おすすめ」 |

### アフィリエイト連携ポイント
| 商品カテゴリ | 連携方法 |
|:-------------|:---------|
| GPS時計（Garmin、COROS） | 「GPXデータを取るならこの時計」として紹介 |
| シューズ（Vaporfly、Alphafly） | 「シミュレーターでPB狙うなら、このシューズ」として紹介 |
| 補給（ジェル、ドリンク） | 給水ポイント機能追加時に連動して紹介 |

### SNS拡散戦略
- 大会前に「〇〇マラソン、VDOT55なら2:58:XX予測」とXに投稿
- ハッシュタグ: #〇〇マラソン #サブ3 #マラソン攻略
- 大会後に「予測と実際の比較」投稿 → 信頼性向上

---

## 5. 次のアクション（実装優先順）

1. [ ] 開発者プロフィールをサイドバーに追加
2. [ ] AkiRunブログへのリンクバナーを追加
3. [ ] 予想タイムの表示を大きく・カラフルに
4. [ ] **コース比較結果に「〇〇がおすすめ」コメントを追加**【動作確認で発見】
5. [ ] 「結果をシェア」ボタンを追加
6. [ ] 給水ポイント通過時刻機能を実装
7. [ ] 気温補正を再実装

---

## 6. 技術的な補足

### Minetti et al. (2002) の勾配エネルギーコスト式について
この論文は「勾配に応じたランニングのエネルギーコスト」を定量化した学術研究。AkiRunのシミュレーターは、この**学術的に検証された式**を実装している点が、他の「経験則ベース」の予測サイトとの最大の差別化ポイント。

### 平滑化パラメータについて
- 現状のデフォルト: 130m
- サイドバーの「詳細設定」から0m〜100mで調整可能
- 窓幅を大きくするとノイズが減るが、急な起伏への反応も鈍くなる

### コース難易度指標（Course Toughness Index）
獲得標高を元に算出。この指標を使って「記録が出やすいコース」をランキング化する記事が書ける。

---

## 7. 参考リンク

- **ブログトップ**: https://akirun.net/
- **アプリ紹介記事**: https://akirun.net/marathon-simulator-guide/
- **LP**: https://akirun.net/lp/marathon-simulator/
- **物理モデル参考論文**: Minetti et al. (2002) "Energy cost of walking and running at extreme uphill and downhill slopes"

---

## 7. 動作確認結果（2026年1月16日実施）

### テスト条件
| 項目 | 入力値 |
|:-----|:-------|
| 設定モード | フルマラソンタイム |
| 目標タイム | 3:30:00 |
| 相当VDOT | 44.60 |
| コースファイル | Berlin_marathon |
| 風速 | 0.00 m/s |
| 風向き | 北 |
| スプリット配分 | イーブン（一定） |
| 坂道強度 | 100% |

### シミュレーション結果
✅ **正常に予想タイムが算出された**

| 項目 | 結果 |
|:-----|:-----|
| 予想タイム | 3:31:10 |
| 平均ペース | 5:00/km |
| 基礎走力（平地相当ペース） | 4:58/km |

### 出力された内容
1. **ペース戦略チャート**: コース起伏と推奨ペースの重ね合わせグラフ ✅
2. **コース平面図**: ベルリン市街地のコースマップ ✅
3. **区間ラップ表（1km毎）**: 全42区間の詳細ラップ ✅
4. **コース比較機能**: 別コースとの比較 ✅

### コース比較テスト
✅ **正常に比較結果が表示された**

| 項目 | Berlin_marathon | Boston_marathon | 差分 |
|:-----|:----------------|:----------------|:-----|
| 予想タイム | 3:31:10 | 3:30:57 | **-13秒** |
| 獲得標高 | 116m | 238m | +122m |
| コース難易度 (Toughness) | 111.6 | 123.9 | +12.3 |

**注目点**: ボストンは獲得標高が2倍以上あるのに13秒速い予測。これは「下り基調」のコースであることを物理モデルが正しく反映している証拠。

### 発見されたUI改善点
1. コース比較結果の「タイム差」（-13秒）がもっと目立つと良い
2. 「どちらが速い」という結論が一目でわかるとユーザーフレンドリー
3. 比較結果に「このコースがPR狙いにおすすめ」のような一言があると親切

---

*このファイルは2026年1月16日時点の情報に基づいています（動作確認済み）*
